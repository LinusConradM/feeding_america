---
title: "Misc Functions"
author: "Ryann Tompkins"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
```

```{r}
fa_pre <- read_excel("../data/feeding_america(2009-2018).xlsx")
fa_post<- read_excel("../data/feeding_america(2019-2023).xlsx")

intersect(names(fa_pre),names(fa_post))
```


Year over year change plot
```{r}

fi_change_plot <- function(
  year_start, year_end,
  variable,
  plot_type = "Slope"
) {
  if (year_start>=2019){
    df_start<-fa_post |> 
      select(fips, value_start = all_of(variable))
  }
  else  {
     df_start<-fa_pre |> 
      select(fips, value_start = all_of(variable))
  }

  if (year_end>=2019){
    df_end<-fa_post |> 
      select(fips, value_end = all_of(variable))
  }
  else  {
     df_end<-fa_pre |> 
      select(fips, value_end = all_of(variable))
  }
  

  df <- df_start |> 
    inner_join(df_end, by = "fips") |> 
    mutate(change = value_end - value_start)

  if (plot_type == "Slope") {
    p <- df %>%
      slice_max(abs(change), n = 30) |> 
      tidyr::pivot_longer(cols = c(value_start, value_end),
                          names_to = "year", values_to = "value") |> 
      mutate(year = recode(year,
                           "value_start" = year_start,
                           "value_end" = year_end)) |> 
      ggplot(aes(x = year, y = value, group = fips)) +
      geom_line(alpha = 0.5) +
      geom_point(size = 2) +
      labs(
        title = paste(variable, "Change:", year_start, "→", year_end),
        y = "Value",
        x = "Year"
      )

  } else if (plot_type == "Histogram") {
    p <- ggplot(df, aes(x = change)) +
      geom_histogram(bins = 30, fill = "steelblue") +
      labs(
        title = paste("Distribution of Change", year_start, "→", year_end),
        x = "Change"
      )

  } else if (plot_type == "Bar Top N") {
    p <- df |> 
      slice_max(abs(change), n = 20) |> 
      ggplot(aes(x = reorder(FIPS, change), y = change)) +
      geom_col(fill = "darkgreen") +
      coord_flip() +
      labs(
        title = paste("Largest Changes in", variable),
        y = "Change"
      )
  }

  return(p + theme_minimal())
}
```


Potential UI
```{r}
ui <- fluidPage(

  titlePanel("Year-over-Year Food Insecurity Change"),

  sidebarLayout(

    sidebarPanel(

      selectInput(
        "year_start",
        "Start Year:",
        choices = 2009:2023,
        selected = "2018"
      ),

      selectInput(
        "year_end",
        "End Year:",
        choices = 2009:2023,
        selected = "2023"
      ),

      selectInput(
        "variable",
        "Variable:",
        choices = c(
          "Overall Food Insecurity Rate",
          "Child Food Insecurity Rate",
          "povert_rate",
          "No of Food Insecure Persons Overall",
          "Cost Per Meal"
        ),
        selected = "Overall Food Insecurity Rate"
      ),

      selectInput(
        "plot_type",
        "Plot Type:",
        choices = c("Slope", "Histogram", "Bar Top N"),
        selected = "Slope"
      )
    ),


    mainPanel(
      plotOutput("change_plot")
    )
  )
)
```


Potantial Server
```{r}
server <- function(input, output, session) {

  output$change_plot <- renderPlot({

    fi_change_plot(
      year_start = input$year_start,
      year_end   = input$year_end,
      variable   = input$variable,
      plot_type  = input$plot_type
    )

  })

}
```
